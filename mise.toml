[tools]
java = "21"
podman = "latest"
"ubi:supabase/cli" = { version = "latest", exe = "supabase" }

[env]
# Podman configuration
# DOCKER_HOST is dynamically detected from podman machine inspect
# If not set, falls back to common default path
_.source = """
# Dynamically detect Podman socket path
PODMAN_SOCKET=$(podman machine inspect podman-machine-default 2>/dev/null | grep -o '/tmp/podman/[^"]*api.sock' | head -1)
if [ -z "$PODMAN_SOCKET" ]; then
  # Fallback to default path if detection fails
  PODMAN_SOCKET="/tmp/podman/podman-machine-default-api.sock"
fi
export DOCKER_HOST="unix://${PODMAN_SOCKET}"
"""

# Backend environment (Viaduct/Kotlin)
SUPABASE_URL = "http://127.0.0.1:54321"
SUPABASE_ANON_KEY = "sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH"
SUPABASE_SERVICE_ROLE_KEY = "sb_secret_N7UND0UgjKTVK-Uodkm0Hg_xSvEMPvz"

# Frontend environment (Vite/React)
VITE_SUPABASE_URL = "http://127.0.0.1:54321"
VITE_SUPABASE_PUBLISHABLE_KEY = "sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH"
VITE_SUPABASE_PROJECT_ID = "mgmfegesdvielbmhixcz"

# Dependency startup tasks
[tasks.podman-start]
description = "Start Podman machine"
run = """
# Start podman machine if not running
podman machine start 2>&1 || echo 'Podman already running'
# Verify socket is accessible
if ! podman info >/dev/null 2>&1; then
  echo "WARNING: Podman socket not accessible. Checking connections..."
  podman system connection list
  echo "Waiting for socket to be ready..."
  sleep 2
fi
"""

[tasks.supabase-start]
description = "Start local Supabase"
depends = ["podman-start"]
run = "supabase start"

[tasks.deps-start]
description = "Start all dependencies (Podman + Supabase)"
depends = ["supabase-start"]

# Build tasks
[tasks.build-backend]
description = "Build Viaduct GraphQL backend"
dir = "backend"
run = "./gradlew clean build"

[tasks.build-frontend]
description = "Build React frontend"
run = "npm run build"

[tasks.build]
description = "Build both backend and frontend"
depends = ["build-backend", "build-frontend"]

# Application tasks
[tasks.backend]
description = "Build and start Viaduct GraphQL backend"
depends = ["deps-start"]
dir = "backend"
run = "./gradlew clean run"

[tasks.frontend]
description = "Start React frontend (with Vite hot-reload)"
run = "npm run dev"

[tasks.dev]
description = "Start full development environment (dependencies + backend + frontend)"
run = """
echo "Starting dependencies..."
mise run deps-start
echo "Starting backend in background..."
mise run backend &
BACKEND_PID=$!
echo "Starting frontend..."
mise run frontend &
FRONTEND_PID=$!
echo "Development environment running!"
echo "Backend PID: $BACKEND_PID"
echo "Frontend PID: $FRONTEND_PID"
wait
"""

# Cleanup tasks
[tasks.kill-dev]
description = "Kill running backend and frontend processes"
run = """
echo "Killing backend processes..."
pkill -f "gradlew.*run" || echo "No backend process found"
echo "Killing frontend processes..."
pkill -f "vite" || echo "No frontend process found"
echo "Development processes stopped"
"""

[tasks.stop]
description = "Stop all services"
run = """
echo "Stopping Supabase..."
supabase stop
echo "Stopping Podman..."
podman machine stop
"""

[tasks.restart]
description = "Restart development environment (kill running processes and start fresh)"
run = """
echo "Restarting development environment..."
mise run kill-dev
echo "Starting fresh development environment..."
mise run dev
"""

[tasks.status]
description = "Check status of all services"
run = """
echo "=== Podman Status ==="
podman machine list
echo ""
echo "=== Podman Connection Info ==="
podman system connection list
echo ""
echo "=== Supabase Status ==="
supabase status
"""

[tasks.diagnose-podman]
description = "Diagnose Podman socket configuration"
run = """
echo "=== Podman Machine Info ==="
podman machine list
echo ""
echo "=== Podman Connection Info ==="
podman system connection list
echo ""
echo "=== Checking Socket Paths ==="
if [ -d /tmp/podman ]; then
  echo "Found /tmp/podman directory:"
  ls -la /tmp/podman/*.sock 2>/dev/null || echo "No sockets found in /tmp/podman"
else
  echo "/tmp/podman directory not found"
fi
echo ""
echo "=== Podman Info (checking connectivity) ==="
if podman info >/dev/null 2>&1; then
  echo "✓ Podman is accessible"
  podman info --format json | grep -E "(remoteSocket|host)" | head -5
else
  echo "✗ Cannot connect to Podman"
fi
"""
