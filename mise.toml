[tools]
java = "21"
podman = "latest"
"ubi:supabase/cli" = { version = "latest", exe = "supabase" }

[env]
# Podman configuration
DOCKER_HOST = "unix:///tmp/podman/podman-machine-default-api.sock"

# Backend environment (Viaduct/Kotlin)
SUPABASE_URL = "http://127.0.0.1:54321"
SUPABASE_ANON_KEY = "sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH"

# Frontend environment (Vite/React)
VITE_SUPABASE_URL = "http://127.0.0.1:54321"
VITE_SUPABASE_PUBLISHABLE_KEY = "sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH"
VITE_SUPABASE_PROJECT_ID = "mgmfegesdvielbmhixcz"

# Dependency startup tasks
[tasks.podman-start]
description = "Start Podman machine"
run = "podman machine start || echo 'Podman already running'"

[tasks.supabase-start]
description = "Start local Supabase"
depends = ["podman-start"]
run = "supabase start"

[tasks.deps-start]
description = "Start all dependencies (Podman + Supabase)"
depends = ["supabase-start"]

# Application tasks
[tasks.backend]
description = "Start Viaduct GraphQL backend"
depends = ["deps-start"]
dir = "backend"
run = "./gradlew run"

[tasks.frontend]
description = "Start React frontend"
run = "npm run dev"

[tasks.dev]
description = "Start full development environment (dependencies + backend + frontend)"
run = """
echo "Starting dependencies..."
mise run deps-start
echo "Starting backend in background..."
mise run backend &
BACKEND_PID=$!
echo "Starting frontend..."
mise run frontend &
FRONTEND_PID=$!
echo "Development environment running!"
echo "Backend PID: $BACKEND_PID"
echo "Frontend PID: $FRONTEND_PID"
wait
"""

# Cleanup tasks
[tasks.stop]
description = "Stop all services"
run = """
echo "Stopping Supabase..."
supabase stop
echo "Stopping Podman..."
podman machine stop
"""

[tasks.status]
description = "Check status of all services"
run = """
echo "=== Podman Status ==="
podman machine list
echo ""
echo "=== Supabase Status ==="
supabase status
"""
